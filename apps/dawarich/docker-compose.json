{
  "$schema": "https://schemas.runtipi.io/v2/dynamic-compose.json",
  "schemaVersion": 2,
  "services": [
    {
      "name": "dawarich_redis",
      "image": "redis:7.4-alpine",
      "command": ["redis-server"],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/dawarich_shared",
          "containerPath": "/data"
        }
      ]
    },
    {
      "name": "dawarich_db",
      "image": "postgis/postgis:17-3.5-alpine",
      "environment": [
        {
          "key": "POSTGRES_USER",
          "value": "postgres"
        },
        {
          "key": "POSTGRES_PASSWORD",
          "value": "password"
        },
        {
          "key": "POSTGRES_DB",
          "value": "dawarich_development"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/dawarich_db_data",
          "containerPath": "/var/lib/postgresql/data"
        },
        {
          "hostPath": "${APP_DATA_DIR}/data/dawarich_shared",
          "containerPath": "/var/shared"
        }
      ],
      "healthCheck": {
        "test": "pg_isready -U postgres -d dawarich_development",
        "interval": "10s",
        "timeout": "10s",
        "retries": 5
      },
      "shmSize": "1G"
    },
    {
      "name": "dawarich",
      "image": "freikin/dawarich:0.32.0",
      "command": [
        "bin/rails",
        "server",
        "-p",
        "3000",
        "-b",
        "::"
      ],
      "environment": [
        {
          "key": "RAILS_ENV",
          "value": "development"
        },
        {
          "key": "REDIS_URL",
          "value": "redis://dawarich_redis:6379"
        },
        {
          "key": "DATABASE_HOST",
          "value": "dawarich_db"
        },
        {
          "key": "DATABASE_USERNAME",
          "value": "postgres"
        },
        {
          "key": "DATABASE_PASSWORD",
          "value": "password"
        },
        {
          "key": "DATABASE_NAME",
          "value": "dawarich_development"
        },
        {
          "key": "MIN_MINUTES_SPENT_IN_CITY",
          "value": "6"
        },
        {
          "key": "APPLICATION_HOSTS",
          "value": "localhost,dawarich.murkmesc.top"
        },
        {
          "key": "DISTANCE_UNIT",
          "value": "km"
        },
        {
          "key": "TIME_ZONE",
          "value": "${TZ}"
        },
        {
          "key": "APPLICATION_PROTOCOL",
          "value": "http"
        },
        {
          "key": "PROMETHEUS_EXPORTER_ENABLED",
          "value": "false"
        },
        {
          "key": "PROMETHEUS_EXPORTER_HOST",
          "value": "0.0.0.0"
        },
        {
          "key": "PROMETHEUS_EXPORTER_PORT",
          "value": "9394"
        },
        {
          "key": "SELF_HOSTED",
          "value": "true"
        },
        {
          "key": "STORE_GEODATA",
          "value": "true"
        },
        {
          "key": "PHOTON_API_HOST",
          "value": "${PHOTON_URL}:${PHOTON_PORT}"
        },
        {
          "key": "PHOTON_API_USE_HTTPS",
          "value": "false"
        }
      ],
      "internalPort": 3000,
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/dawarich_public",
          "containerPath": "/var/app/public"
        },
        {
          "hostPath": "${APP_DATA_DIR}/data/dawarich_watched",
          "containerPath": "/var/app/tmp/imports/watched"
        },
        {
          "hostPath": "${APP_DATA_DIR}/data/dawarich_storage",
          "containerPath": "/var/app/storage"
        },
        {
          "hostPath": "${APP_DATA_DIR}/data/dawarich_db_data",
          "containerPath": "/dawarich_db_data"
        }
      ],
      "healthCheck": {
        "test": "wget -qO - http://127.0.0.1:3000/api/v1/health | grep -q \"status.*ok\"",
        "interval": "10s",
        "timeout": "10s",
        "retries": 30
      },
      "entrypoint": "web-entrypoint.sh",
      "tty": true,
      "stdinOpen": true,
      "dependsOn": {
        "dawarich_db": {
          "condition": "service_started"
        },
        "dawarich_redis": {
          "condition": "service_started"
        }
      },
      "isMain": true
    },
    {
      "name": "dawarich_sidekiq",
      "image": "freikin/dawarich:0.32.0",
      "command": [
        "sidekiq"
      ],
      "environment": [
        {
          "key": "RAILS_ENV",
          "value": "development"
        },
        {
          "key": "REDIS_URL",
          "value": "redis://dawarich_redis:6379"
        },
        {
          "key": "DATABASE_HOST",
          "value": "dawarich_db"
        },
        {
          "key": "DATABASE_USERNAME",
          "value": "postgres"
        },
        {
          "key": "DATABASE_PASSWORD",
          "value": "password"
        },
        {
          "key": "DATABASE_NAME",
          "value": "dawarich_development"
        },
        {
          "key": "APPLICATION_HOSTS",
          "value": "localhost,dawarich.murkmesc.top"
        },
        {
          "key": "BACKGROUND_PROCESSING_CONCURRENCY",
          "value": "10"
        },
        {
          "key": "APPLICATION_PROTOCOL",
          "value": "http"
        },
        {
          "key": "PROMETHEUS_EXPORTER_ENABLED",
          "value": "false"
        },
        {
          "key": "PROMETHEUS_EXPORTER_HOST",
          "value": "dawarich"
        },
        {
          "key": "PROMETHEUS_EXPORTER_PORT",
          "value": "9394"
        },
        {
          "key": "SELF_HOSTED",
          "value": "true"
        },
        {
          "key": "STORE_GEODATA",
          "value": "true"
        },
        {
          "key": "PHOTON_API_HOST",
          "value": "${PHOTON_URL}:${PHOTON_PORT}"
        },
        {
          "key": "PHOTON_API_USE_HTTPS",
          "value": "false"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/dawarich_public",
          "containerPath": "/var/app/public"
        },
        {
          "hostPath": "${APP_DATA_DIR}/data/dawarich_watched",
          "containerPath": "/var/app/tmp/imports/watched"
        },
        {
          "hostPath": "${APP_DATA_DIR}/data/dawarich_storage",
          "containerPath": "/var/app/storage"
        }
      ],
      "healthCheck": {
        "test": "pgrep -f sidekiq",
        "interval": "10s",
        "timeout": "10s",
        "retries": 30
      },
      "entrypoint": "sidekiq-entrypoint.sh",
      "tty": true,
      "stdinOpen": true,
      "dependsOn": {
        "dawarich_db": {
          "condition": "service_started"
        },
        "dawarich_redis": {
          "condition": "service_started"
        },
        "dawarich": {
          "condition": "service_started"
        }
      }
    }
  ]
}
